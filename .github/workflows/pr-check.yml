# PR 构建检查工作流
name: PR Build Check

# 触发条件：当创建或更新 pull request 时
on:
  pull_request:
    # 只在这些分支的 PR 时触发
    branches: [ main ]
    # 忽略这些文件的变更
    paths-ignore:
      - "**.md"
      - ".idea"
      - ".vscode"
      - ".dockerignore"
      - "Dockerfile"
      - ".gitignore"
      - ".github/**"
      - "!.github/workflows/**"

# 设置工作流权限
permissions:
  contents: read
  pull-requests: write

jobs:
  # 构建检查任务
  build-check:
    name: Build Check
    runs-on: ubuntu-latest

    steps:
      # 步骤1：检出代码
      - name: Checkout Code
        uses: actions/checkout@v3

      # 步骤2：设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18
          # 启用依赖缓存
          cache: 'npm'

      # 步骤3：安装依赖
      - name: Install Dependencies
        run: npm install

      # 步骤4：运行构建
      - name: Build Project
        run: npm run build

      # 步骤5：添加构建结果评论
      - name: Add PR Comment
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const buildStatus = process.env.JOB_STATUS || 'success';
            const emoji = buildStatus === 'success' ? '✅' : '❌';
            const message = `${emoji} 构建检查结果: ${buildStatus === 'success' ? '通过' : '失败'}

            - Node.js 版本: 18
            - 构建命令: \`npm run build\`
            - 构建时间: ${new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })}

            ${buildStatus === 'success' 
              ? '✨ 所有依赖更新和构建检查均已通过，可以安全合并。' 
              : '⚠️ 构建检查失败，请检查日志了解详细信息。'}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });
        env:
          JOB_STATUS: ${{ job.status }}


